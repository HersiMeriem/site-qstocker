<div class="product-list-container">
  <header class="list-header">
    <div class="header-top">
      <h1 class="title">ðŸ“¦ Liste des Produits</h1>
      <div class="promo-btn-container">
        <!-- SupprimÃ© l'ancien bouton de promotion -->
      </div>
    </div>
    <div class="controls">
      <div class="search-box">
        <input type="text" 
               [(ngModel)]="searchTerm" 
               (input)="filterProducts()"
               placeholder="Rechercher par nom, ID, type ou catÃ©gorie..."
               class="search-input">
        <i class="fas fa-search search-icon"></i>
      </div>

      <div class="filters">
        <select [(ngModel)]="selectedCategory" (change)="filterProducts()" class="form-select">
          <option value="">Toutes catÃ©gories</option>
          <option *ngFor="let cat of categories" [value]="cat">{{cat}}</option>
        </select>

        <select [(ngModel)]="selectedType" (change)="filterProducts()" class="form-select">
          <option value="">Tous types</option>
          <option *ngFor="let type of types" [value]="type">{{type}}</option>
        </select>
      </div>
    </div>
  </header>

  <!-- ContrÃ´les de sÃ©lection -->
  <div class="selection-controls" *ngIf="filteredProducts.length > 0">
    <mat-checkbox
      [checked]="isAllSelected()"
      [indeterminate]="selection.hasValue() && !isAllSelected()"
      (change)="toggleAll()">
      SÃ©lectionner tout
    </mat-checkbox>

    <button 
      (click)="openPromotionDialog()" 
      class="promo-btn"
      [disabled]="selection.selected.length === 0 || isPromotionDialogOpen">
      <i class="fas fa-tag"></i> 
      Appliquer promotion ({{selection.selected.length}})
    </button>
  </div>

  <div class="product-grid">
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Chargement des produits...</p>
    </div>

    <div *ngFor="let product of filteredProducts" class="product-card">
      <!-- Checkbox de sÃ©lection -->
      <mat-checkbox
        [checked]="selection.isSelected(product)"
        (change)="selection.toggle(product)"
        class="product-checkbox">
      </mat-checkbox>

      <div class="card-content">
        <div class="image-section">
          <img [src]="product.imageUrl || 'assets/default-product.png'" 
               alt="Image produit"
               class="product-image">
          
          <div class="product-identifier">
            <div class="qr-wrapper">
              <img [src]="product.qrCode" 
                   alt="QR Code" 
                   class="qr-code">
            </div>
            <span class="product-id">REF-{{ product.id | slice:0:8 }}</span>
          </div>
        </div>

        <div class="product-details">
          <div *ngIf="product.status === 'promotion'" class="promotion-badge">
            <i class="fas fa-tag"></i> PROMO -{{ product.promotion?.discountPercentage }}%
            <span *ngIf="!isPromotionActive(product)" class="expired-text">(ExpirÃ©e)</span>
          </div>

          <div class="badge-group">
            <span class="type-badge">{{ product.type }}</span>
            <span class="category-badge">{{ product.category }}</span>
          </div>
          <h3 class="product-name">{{ product.name }}</h3>
          <p class="product-description">
            {{ product.description | truncate:100 }}
          </p> 
        
          <div class="product-meta">
            <div class="meta-item">
              <i class="fas fa-tag"></i>
              <span *ngIf="product.status === 'promotion' && isPromotionActive(product)" class="price">
                <del>{{ product.unitPrice | number:'1.2-2' }} DT</del>
                {{ calculateDiscountedPrice(product) | number:'1.2-2' }} DT
                <span class="discount-badge">-{{ product.promotion?.discountPercentage }}%</span>
              </span>
              <span *ngIf="product.status !== 'promotion' || !isPromotionActive(product)">
                {{ product.unitPrice | number:'1.2-2' }} DT
              </span>
            </div>
            <div class="meta-item">
              <i class="fas fa-box"></i>
              <span>{{ product.stockQuantity }} en stock</span>
            </div>
            
            <div class="meta-item">
              <i class="fas fa-info-circle"></i>
              <span class="status-badge" [ngClass]="'status-' + product.status">
                {{ getStatusLabel(product.status) }}
              </span>
            </div>
          </div>

          <div class="action-buttons">
            <button class="action-btn info" (click)="viewDetails(product.id)" matTooltip="Voir plus de dÃ©tails">
              <i class="fas fa-eye"></i> 
            </button>
            
            <button class="action-btn warning" (click)="editProduct(product.id)" matTooltip="Modifier">
              <i class="fas fa-pencil-alt"></i>
            </button>
            
            <button class="action-btn danger" (click)="deleteProduct(product.id)" matTooltip="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!loading && filteredProducts.length === 0" class="empty-state">
      <i class="fas fa-box-open"></i>
      <p>Aucun produit trouvÃ©</p>
      <a routerLink="/responsable/product-add" class="add-button">
        <i class="fas fa-plus"></i> Ajouter un produit
      </a>
    </div>
  </div>
</div>

<div class="add-product-container">
  <a routerLink="/responsable/product-add" class="add-product-btn">âž• Ajouter un produit</a>
</div>